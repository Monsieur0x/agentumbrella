# Umbrella Bot — ИИ-агент для координации тестирования

Telegram-бот на базе Claude AI для управления командой тестеров Dota 2 чита Umbrella. Понимает естественный язык, управляет баллами, багами, рейтингом и интегрируется с Weeek.

## Возможности

### Ролевая система
- **Владелец** — полный контроль: управление админами, переключение режимов бота, настройка интеграций
- **Админы** — начисление/списание баллов, предупреждения, задания, модерация багов, рейтинг
- **Тестеры** — просмотр статистики, рейтинга, отправка багрепортов

### Баллы и награды
- Начисление/списание баллов с указанием причины
- Массовое начисление (нескольким или всем тестерам)
- Настраиваемые значения баллов за каждое действие (баг, краш, игра)
- Полный лог всех транзакций

### Система предупреждений
- Выдача предупреждений с причиной
- Автоматическая деактивация тестера при 3 предупреждениях
- Снятие предупреждений (индивидуально и массово)
- Автоматическая реактивация при снижении варнов ниже 3

### Багрепорты
- Пошаговая подача: название скрипта, YouTube-ссылка, файл-доказательство
- Типы: баг или краш
- Статусы: ожидание файла → на рассмотрении → принят/отклонён/дубликат
- Проверка дубликатов через владельца
- Автоначисление баллов при принятии
- Поиск и удаление багов

### Задания
- Создание задания из краткого описания
- ИИ расширяет бриф в полноценное описание задачи
- Черновик с возможностью редактирования перед публикацией
- Публикация в топик «Задания»

### Аналитика
- Статистика тестера: баллы, баги, краши, игры, варны
- Командная аналитика по периодам (сегодня/неделя/месяц/всё время)
- Топ-3 тестеров, средние показатели
- Поиск неактивных тестеров за N дней
- Сравнение двух тестеров
- Статистика по багам с разбивкой по типам и периодам

### Рейтинг
- Динамический рейтинг по баллам с детальной статистикой
- Публикация в топик «Топ» группы

### Режимы работы бота
- **Активный** — отвечает на все сообщения
- **Наблюдение** — отвечает только на прямые @упоминания

### Интеграция с Weeek
- Создание задач из багрепортов
- Выбор доски и колонки через inline-кнопки
- Загрузка файлов-вложений
- Удаление задач из Weeek
- Кэширование данных проектов
- Включение/отключение интеграции на лету

---

## Технологии

- **Python 3.11+**, aiogram 3.15
- **Claude AI** (claude-haiku-4-5) — 24 инструмента через function calling
- **SQLite** (WAL mode) — тестеры, админы, баги, баллы, варны, задания, настройки
- **Weeek API** — управление проектами
- **httpx** — HTTP-клиент

---

## Установка

### 1. Зависимости

```bash
pip install -r requirements.txt
```

### 2. Настройка .env

```bash
cp .env.example .env
```

Заполни `.env`:

```env
BOT_TOKEN=...                # от @BotFather
OWNER_TELEGRAM_ID=...        # твой Telegram ID
ANTHROPIC_API_KEY=...        # от console.anthropic.com
WEEEK_API_KEY=...            # от Weeek (можно оставить пустым)
GROUP_ID=-100xxxxxxxxxx      # ID суперугрппы
MODEL=claude-haiku-4-5-20251001  # модель Claude (по умолчанию haiku)
MAX_TOKENS=1024              # лимит токенов ответа
MAX_TOOL_ROUNDS=3            # макс. итераций вызова инструментов

# ID топиков группы
TOPIC_GENERAL=1
TOPIC_TASKS=...
TOPIC_BUGS=...
TOPIC_CRASHES=...
TOPIC_TOP=...
TOPIC_LOGS=...
TOPIC_LOGINS=...

DEBUG_TOPICS=0               # 1 = показывать ID топиков при запуске
```

### 3. Узнать ID группы и топиков

1. Поставь `GROUP_ID=0` и `DEBUG_TOPICS=1`
2. Запусти `python bot.py`
3. Напиши сообщение в каждом топике группы — бот ответит ID
4. Впиши ID в `.env`, поставь `DEBUG_TOPICS=0`

### 4. Запуск

```bash
python bot.py
```

```
Запуск Umbrella Bot...
База данных инициализирована
Бот: @your_bot (ID: 123456)
Владелец: 123456789
Бот запущен! Ожидание сообщений...
```

---

## Использование

### Обращение к боту в группе
- **Реплай** на сообщение бота
- **@упоминание**: `@your_bot покажи рейтинг`

### Примеры команд (естественный язык)

**Баллы:**
- «Начисли @vasya 5 баллов за хорошую работу»
- «Сними у @petrov 3 балла»
- «Дай всем по 2 балла»

**Аналитика:**
- «Как дела у команды за неделю?»
- «Покажи статистику @vasya»
- «Кто не работал 3 дня?»
- «Сравни @petrov и @sidorov»

**Рейтинг:**
- «Покажи рейтинг»
- «Обнови рейтинг в топик»

**Предупреждения:**
- «Предупреди @sidorov за неактивность»
- «Сними варн @vasya»
- «Сними варны всем»

**Задания:**
- «Дай задание — потестить 5 уровень»

**Управление (владелец):**
- «Режим наблюдение» / «Рабочий режим»
- «Включи вик» / «Выключи вик»
- «Добавь админа @username» / «Удали админа @username»

**Багрепорты (в топике «Баги»):**
Тестер отправляет сообщение с хештегом `#баг`, указывая название скрипта, YouTube-ссылку и файл-доказательство.

---

## Структура проекта

```
├── bot.py                     # Точка входа
├── config.py                  # Конфигурация из .env
├── database.py                # SQLite с WAL mode
├── requirements.txt           # Зависимости
│
├── agent/                     # Мозг ИИ-агента
│   ├── brain.py               # Claude API, function calling, история диалогов
│   ├── system_prompt.py       # Динамический системный промпт по роли
│   ├── tools.py               # 24 инструмента + keyword-matching
│   └── tool_executor.py       # Диспетчер и выполнение инструментов
│
├── handlers/                  # Обработчики Telegram
│   ├── message_router.py      # Роутер сообщений (группа, ЛС, топики)
│   ├── bug_handler.py         # Приём и валидация багрепортов
│   └── callback_handler.py    # Inline-кнопки (подтверждение, выбор доски)
│
├── models/                    # Модели данных и CRUD
│   ├── tester.py              # Тестеры
│   ├── admin.py               # Админы
│   ├── bug.py                 # Баги
│   └── settings.py            # Настройки наград
│
├── services/                  # Бизнес-логика
│   ├── points_service.py      # Начисление/списание баллов
│   ├── rating_service.py      # Рейтинг и публикация
│   ├── weeek_service.py       # Weeek API клиент
│   └── duplicate_checker.py   # Проверка дублей багов
│
└── utils/
    └── logger.py              # Логирование в топик Logs
```

---

## Инструменты ИИ-агента (24)

| Категория | Инструмент | Описание |
|---|---|---|
| Аналитика | `get_tester_stats` | Статистика тестера |
| | `get_team_stats` | Обзор команды по периоду |
| | `get_inactive_testers` | Неактивные тестеры |
| | `compare_testers` | Сравнение двух тестеров |
| | `get_bug_stats` | Статистика багов |
| | `get_testers_list` | Список всех тестеров |
| Баллы | `award_points` | Начисление одному |
| | `award_points_bulk` | Массовое начисление |
| Предупреждения | `issue_warning` | Выдать предупреждение |
| | `issue_warning_bulk` | Массовая выдача |
| | `remove_warning` | Снять/сбросить предупреждения |
| Задания | `create_task` | Создать и расширить задание |
| Рейтинг | `get_rating` | Сформировать рейтинг |
| | `publish_rating` | Опубликовать в группу |
| Админы | `manage_admin` | Добавить/удалить/список |
| Баги | `mark_bug_duplicate` | Отметить дубликат |
| | `search_bugs` | Поиск багов |
| | `delete_bug` | Удалить из БД/Weeek |
| Утилиты | `refresh_testers` | Синхронизация с группой |
| | `switch_mode` | Переключение режима бота |

---

## Безопасность

- Проверка роли на уровне выполнения каждого инструмента
- Владелец задаётся через переменную окружения
- API-ключи хранятся в `.env` (не коммитится)
- HTML-экранирование пользовательского ввода
- Тестеры имеют доступ только к своим данным

---

## Лицензия

Проприетарный проект. Все права защищены.
